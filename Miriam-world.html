<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Miriam's Urban World</title>
  <style>
    @font-face{
      font-family:'DimitriFont';
      src:url('./font/DIMITRI_.TTF') format('truetype');
      font-weight:normal; font-style:normal; font-display:swap;
    }
    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'DimitriFont', Arial, sans-serif;
      background:#0a0a0a url('lagif.gif') center/cover no-repeat;
      min-height:100vh; color:white; overflow-x:hidden; position:relative;
    }
    body::before{
      content:''; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1;
    }
    .content{ position:relative; z-index:2; }

    /* Header */
    .header{
      position:fixed; top:0; left:0; right:0;
      background:rgba(0,0,0,0.9); backdrop-filter:blur(20px);
      padding:15px 30px; display:flex; justify-content:space-between; align-items:center;
      z-index:100; border-bottom:2px solid #A48D6F;
    }
    .logo{ height:40px; filter:drop-shadow(0 0 10px #A48D6F); cursor:pointer; }
    .player-info{ display:flex; align-items:center; gap:15px; color:#A48D6F; font-size:1.2rem; text-shadow:0 0 10px #A48D6F; }
    .sound-toggle{
      width:50px;height:50px;border-radius:50%;
      background:linear-gradient(45deg,#A48D6F,#71685F);
      border:none;color:white;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s ease;
      box-shadow:0 0 20px rgba(164,141,111,0.3);
    }
    .sound-toggle:hover{ transform:scale(1.1); box-shadow:0 0 30px rgba(164,141,111,0.5); }

    /* World */
    .game-world{
      margin-top:80px; padding:20px; min-height:calc(100vh - 80px);
      display:flex; flex-direction:column; align-items:center; position:relative;
    }
    .world-title{
      font-size:3rem; color:#A48D6F; text-shadow:0 0 20px #A48D6F; margin-bottom:40px; text-align:center;
      animation:glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow{
      from{ text-shadow:0 0 20px #A48D6F; }
      to{ text-shadow:0 0 30px #A48D6F,0 0 40px #A48D6F; }
    }
    .world-zones{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:25px; max-width:1000px; width:100%; margin-bottom:30px;
    }
    .zone{
      background:linear-gradient(135deg, rgba(164,141,111,0.1), rgba(113,104,95,0.1));
      border:2px solid rgba(164,141,111,0.3); border-radius:20px; padding:25px; text-align:center; cursor:pointer; transition:all .3s ease; backdrop-filter:blur(10px);
      box-shadow:0 8px 25px rgba(0,0,0,0.3); position:relative; overflow:hidden;
    }
    .zone:hover{ transform:translateY(-10px); border-color:#A48D6F; box-shadow:0 15px 35px rgba(164,141,111,0.2); }
    .zone::before{
      content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
      background:linear-gradient(90deg,transparent,rgba(164,141,111,0.2),transparent); transition:left .5s;
    }
    .zone:hover::before{ left:100%; }
    .zone-icon{ font-size:3.5rem; margin-bottom:15px; position:relative; z-index:1; }
    .zone-title{ font-size:1.6rem; color:#A48D6F; margin-bottom:10px; text-shadow:0 0 10px rgba(164,141,111,0.5); position:relative; z-index:1; }
    .zone-description{ color:#ccc; font-size:.9rem; font-family:Arial, sans-serif; position:relative; z-index:1; }

    /* Character */
    .miriam-character{
      position:fixed; bottom:20px; right:20px; width:150px; height:300px;
      background-image:url('images/char2.png.PNG'); background-size:cover; background-position:center; z-index:50;
      filter:drop-shadow(0 0 20px rgba(164,141,111,0.3)); animation:float 3s ease-in-out infinite;
    }
    @keyframes float{ 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(-15px); } }

    /* Particles */
    .particles{ position:fixed; inset:0; pointer-events:none; z-index:3; }
    .particle{ position:absolute; width:4px; height:4px; background:#A48D6F; border-radius:50%; animation:float-particle 8s linear infinite; opacity:.6; }
    @keyframes float-particle{
      0%{ transform:translateY(100vh) translateX(0); opacity:0; }
      10%{ opacity:.6; }
      90%{ opacity:.6; }
      100%{ transform:translateY(-100px) translateX(100px); opacity:0; }
    }

    /* Minigame Panel */
    .minigame-panel{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:linear-gradient(135deg, rgba(48,39,34,0.95), rgba(113,104,95,0.95));
      border:2px solid #A48D6F; border-radius:25px; padding:30px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,0.8);
      z-index:200; display:none; min-width:500px; max-width:90vw; max-height:90vh; overflow-y:auto; backdrop-filter:blur(20px);
    }
    .minigame-title{ font-size:2.2rem; color:#A48D6F; margin-bottom:20px; text-shadow:0 0 15px #A48D6F; }
    .minigame-content{ margin-bottom:20px; color:#ccc; }

    /* Buttons */
    .close-btn,.action-btn{
      background:linear-gradient(45deg,#A48D6F,#71685F); color:white; border:none; padding:12px 25px; border-radius:25px; cursor:pointer; font-size:1rem; margin:10px 5px; transition:all .3s ease; font-family:'DimitriFont', Arial, sans-serif; box-shadow:0 5px 15px rgba(164,141,111,0.3);
    }
    .close-btn:hover,.action-btn:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(164,141,111,0.4); }

    /* TicTacToe */
    .tictactoe-game{ margin:20px auto; }
    .game-mode-selector{ display:flex; gap:10px; justify-content:center; margin-bottom:20px; }
    .mode-btn{ padding:10px 20px; background:rgba(164,141,111,0.3); border:2px solid #A48D6F; border-radius:15px; color:white; cursor:pointer; transition:all .3s ease; font-family:'DimitriFont', Arial, sans-serif; }
    .mode-btn.active{ background:linear-gradient(45deg,#A48D6F,#71685F); box-shadow:0 0 20px rgba(164,141,111,0.5); }
    .mode-btn:hover{ transform:scale(1.05); }
    .tictactoe-board{ display:grid; grid-template-columns:repeat(3,90px); grid-template-rows:repeat(3,90px); gap:8px; margin:0 auto; justify-content:center; }
    .tictactoe-cell{
      width:90px;height:90px;background:rgba(164,141,111,0.2);border:2px solid #A48D6F;border-radius:15px;font-size:2.5rem;color:white;cursor:pointer;transition:all .3s ease; display:flex;align-items:center;justify-content:center;font-family:Arial, sans-serif;font-weight:bold;
    }
    .tictactoe-cell:hover:not(:disabled){ background:rgba(164,141,111,0.4); transform:scale(1.05); box-shadow:0 0 15px rgba(164,141,111,0.3); }
    .tictactoe-cell:disabled{ cursor:not-allowed; opacity:.7; }
    .tictactoe-cell.x{ color:#ff6b9d; text-shadow:0 0 10px #ff6b9d; }
    .tictactoe-cell.o{ color:#4fc3f7; text-shadow:0 0 10px #4fc3f7; }
    .tictactoe-info{ text-align:center; margin:20px 0; font-size:1.2rem; color:#A48D6F; text-shadow:0 0 10px rgba(164,141,111,0.5); }
    .tictactoe-score{ display:flex; justify-content:space-around; margin:20px 0; font-size:1rem; }
    .score-item{ padding:10px 15px; background:rgba(164,141,111,0.2); border-radius:10px; border:1px solid #A48D6F; }

    /* Design Studio Canvas */
    #drawingCanvas{
      border:3px solid #A48D6F; border-radius:15px; background:white; cursor:crosshair; margin:15px auto; display:block; box-shadow:0 0 20px rgba(164,141,111,0.3);
    }
    .drawing-tools{
      display:flex; gap:15px; justify-content:center; align-items:center; flex-wrap:wrap; margin:20px 0; padding:15px; background:rgba(164,141,111,0.1); border-radius:15px;
    }
    .tool-group{ display:flex; align-items:center; gap:10px; }
    .tool-label{ color:#A48D6F; font-size:1rem; text-shadow:0 0 5px rgba(164,141,111,0.3); }
    #colorPicker{
      width:60px;height:60px;border:3px solid #A48D6F;border-radius:50%;cursor:pointer;transition:all .3s ease;
    }
    #colorPicker:hover{ transform:scale(1.1); box-shadow:0 0 15px rgba(164,141,111,0.5); }
    #brushSize{ width:150px;height:8px;border-radius:5px;background:rgba(164,141,111,0.3); outline:none; cursor:pointer; }
    #brushSize::-webkit-slider-thumb{
      width:20px;height:20px;border-radius:50%;background:linear-gradient(45deg,#A48D6F,#71685F);cursor:pointer;border:2px solid white;box-shadow:0 0 10px rgba(164,141,111,0.5);
    }
    #brushSize::-moz-range-thumb{
      width:20px;height:20px;border-radius:50%;background:linear-gradient(45deg,#A48D6F,#71685F);cursor:pointer;border:2px solid white;box-shadow:0 0 10px rgba(164,141,111,0.5);
    }
    .drawings-gallery{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:15px; margin:20px 0; max-height:300px; overflow-y:auto; padding:10px; background:rgba(0,0,0,0.2); border-radius:15px;
    }
    .drawing-item{ position:relative; border:2px solid #A48D6F; border-radius:10px; overflow:hidden; cursor:pointer; transition:all .3s ease; background:white; }
    .drawing-item:hover{ transform:scale(1.05); box-shadow:0 0 20px rgba(164,141,111,0.5); }
    .drawing-item img{ width:100%; height:100px; object-fit:cover; display:block; }
    .drawing-item .drawing-author{ background:rgba(164,141,111,0.95); color:white; padding:5px; font-size:.8rem; text-align:center; font-family:Arial, sans-serif; }
    .drawing-item .delete-btn{
      position:absolute; top:5px; right:5px; background:rgba(255,0,0,0.8); color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer; font-size:.8rem; display:none; align-items:center; justify-content:center;
    }
    .drawing-item:hover .delete-btn{ display:flex; }

    /* Leaderboard Panel */
    .leaderboard-panel{
      position:fixed; bottom:20px; left:20px;
      background:linear-gradient(135deg, rgba(48,39,34,0.9), rgba(113,104,95,0.9));
      border:2px solid rgba(164,141,111,0.3); border-radius:15px; padding:16px; min-width:260px; z-index:60; backdrop-filter:blur(10px);
      box-shadow:0 8px 20px rgba(0,0,0,0.3);
    }
    .leaderboard-panel h3{ margin:0 0 10px; color:#A48D6F; font-size:1rem; text-shadow:0 0 8px rgba(164,141,111,.5); }
    .leaderboard-panel .lb-controls{ display:flex; gap:8px; margin-bottom:10px; }
    .name-input{
      width:100%; padding:10px 14px; border-radius:20px; border:2px solid #A48D6F;
      background:rgba(255,255,255,0.9); color:#333; font-size:.9rem; font-family:Arial, sans-serif; outline:none;
    }
    .leaderboard-panel ul{ list-style:none; margin:0; padding:0; max-height:180px; overflow:auto; }
    .leaderboard-panel li{
      display:flex; justify-content:space-between; gap:10px; padding:6px 10px; margin-bottom:6px; border-radius:10px;
      background:rgba(164,141,111,0.15); border:1px solid rgba(164,141,111,0.35); font-family:Arial, sans-serif; font-size:.9rem; color:#eee;
    }

    /* Score popup */
    .score-popup{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:linear-gradient(45deg,#A48D6F,#71685F); color:white; padding:20px 30px; border-radius:15px; font-size:1.5rem; z-index:300; box-shadow:0 10px 30px rgba(164,141,111,0.5);
      animation:popup 2s ease-out; display:none;
    }
    @keyframes popup{
      0%{ transform:translate(-50%,-50%) scale(0); opacity:0; }
      50%{ transform:translate(-50%,-50%) scale(1.1); opacity:1; }
      100%{ transform:translate(-50%,-50%) scale(1); opacity:1; }
    }
  </style>

  <!-- Firebase (module): remplis la configuration ci-dessous -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where, doc, getDoc, setDoc, updateDoc, increment, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // REMPLACER par la config de ton projet Firebase (Console > Project settings > SDK setup)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      appId: "YOUR_APP_ID"
    }; // Nécessaire pour activer Firestore/Storage côté Web[web:220]

    const app = initializeApp(firebaseConfig); // Initialise Firebase[web:220]
    const auth = getAuth(app);                // Auth anonyme pour autoriser l’écriture[web:220]
    await signInAnonymously(auth);            // Connexion sans compte pour tous[web:220]

    const db = getFirestore(app);             // Base temps réel Firestore[web:142]
    const storage = getStorage(app);          // Stockage d’images public/lecture[web:207]

    // Expose pour le script non-module
    window.FB = {
      db, storage, auth,
      fns: { collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where, doc, getDoc, setDoc, updateDoc, increment, limit, ref, uploadBytes, getDownloadURL }
    };
  </script>
</head>
<body>
  <div class="content">
    <audio id="backgroundMusic" loop autoplay>
      <source src="music/Victoria%20Monét%20-%20Dive%20(Lyric%20Video).mp3" type="audio/mpeg"/>
    </audio>

    <div class="header">
      <img src="baddielogo.png.PNG" alt="Logo" class="logo" onclick="window.location.href='index.html'"/>
      <div class="player-info"><span>🌙 Miriam's Urban Loft</span></div>
      <button class="sound-toggle" id="soundToggle">🔊</button>
    </div>

    <div class="particles" id="particles"></div>

    <div class="game-world">
      <h1 class="world-title">✨ Atelier de Miriam ✨</h1>

      <div class="world-zones">
        <!-- Design Studio -->
        <div class="zone" onclick="startMinigame('design')">
          <div class="zone-icon">🎨</div>
          <div class="zone-title">Design Studio</div>
          <div class="zone-description">Dessine tes créations sur la toile</div>
        </div>
        <!-- Rooftop Morpion -->
        <div class="zone" onclick="startMinigame('rooftop')">
          <div class="zone-icon">🌃</div>
          <div class="zone-title">Rooftop Morpion</div>
          <div class="zone-description">Joue seul ou à 2</div>
        </div>
        <!-- Mini Tetris -->
        <div class="zone" onclick="startMinigame('tetris')">
          <div class="zone-icon">🧱</div>
          <div class="zone-title">Mini Tetris</div>
          <div class="zone-description">Empile et aligne</div>
        </div>
        <!-- Wordle -->
        <div class="zone" onclick="startMinigame('wordle')">
          <div class="zone-icon">🔤</div>
          <div class="zone-title">Wordle</div>
          <div class="zone-description">Un mot aléatoire à deviner</div>
        </div>
        <!-- Memory -->
        <div class="zone" onclick="startMinigame('memory')">
          <div class="zone-icon">🧠</div>
          <div class="zone-title">Memory Match</div>
          <div class="zone-description">Retourne les paires</div>
        </div>
        <!-- Puissance 4 -->
        <div class="zone" onclick="startMinigame('connect4')">
          <div class="zone-icon">🟡</div>
          <div class="zone-title">Puissance 4</div>
          <div class="zone-description">Aligne 4 jetons</div>
        </div>
      </div>
    </div>

    <div class="miriam-character"></div>

    <!-- Leaderboard panel -->
    <div class="leaderboard-panel" id="leaderboardPanel">
      <h3>🏆 Classement (semaine <span id="lbWeek"></span>)</h3>
      <div class="lb-controls">
        <input id="lbName" class="name-input" placeholder="Ton prénom..." />
        <button class="action-btn" id="lbSave">OK</button>
      </div>
      <ul id="leaderboardList"></ul>
    </div>

    <!-- Modal Minigame -->
    <div class="minigame-panel" id="minigamePanel">
      <h2 class="minigame-title" id="gameTitle">Mini-Game</h2>
      <div class="minigame-content" id="gameContent"></div>
      <button class="close-btn" onclick="closeMinigame()">Fermer</button>
    </div>

    <div class="score-popup" id="scorePopup">+1 point ! ✨</div>
  </div>

  <script>
    // Audio toggle
    let isMuted=false;
    const soundToggle=document.getElementById('soundToggle');
    const backgroundMusic=document.getElementById('backgroundMusic');
    soundToggle.addEventListener('click',()=>{
      if(isMuted){ backgroundMusic.play(); soundToggle.textContent='🔊'; isMuted=false; }
      else{ backgroundMusic.pause(); soundToggle.textContent='🔇'; isMuted=true; }
    });

    // Particles
    function createParticles(){
      const particles=document.getElementById('particles');
      setInterval(()=>{
        const p=document.createElement('div');
        p.className='particle';
        p.style.left=Math.random()*100+'vw';
        p.style.animationDelay=Math.random()*2+'s';
        particles.appendChild(p);
        setTimeout(()=>p.remove(),8000);
      },800);
    }

    // Score popup
    function showScorePopup(text){
      const popup=document.getElementById('scorePopup');
      popup.textContent=text;
      popup.style.display='block';
      setTimeout(()=>{ popup.style.display='none'; },2000);
    }

    // ============ Semaine ISO ============
    function getWeekId(d=new Date()){
      const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      date.setUTCDate(date.getUTCDate()+4-(date.getUTCDay()||7));
      const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo=Math.ceil((((date - yearStart)/86400000)+1)/7);
      const yy=date.getUTCFullYear();
      const ww=String(weekNo).padStart(2,'0');
      return `${yy}-${ww}`;
    }

    // ============ Leaderboard (Firestore temps réel) ============
    function lbPath(){ return `leaderboards/${getWeekId()}/scores`; }
    async function addWinPoint(name){
      if(!name || !window.FB) return;
      const { doc, getDoc, setDoc, updateDoc, increment } = FB.fns;
      const ref = doc(FB.db, lbPath(), name.trim().toLowerCase());
      const snap = await getDoc(ref);
      if(!snap.exists()) await setDoc(ref,{ name, points:1 });
      else await updateDoc(ref,{ points: increment(1) });
    }
    async function ensureNameRegistered(name){
      if(!name || !window.FB) return;
      const { doc, getDoc, setDoc } = FB.fns;
      const ref = doc(FB.db, lbPath(), name.trim().toLowerCase());
      const snap = await getDoc(ref);
      if(!snap.exists()) await setDoc(ref,{ name, points:0 });
    }
    function renderLeaderboard(){
      if(!window.FB) return;
      const ul=document.getElementById('leaderboardList');
      const w=document.getElementById('lbWeek');
      if(!ul||!w) return;
      w.textContent=getWeekId();
      const { collection, query, orderBy, limit, onSnapshot } = FB.fns;
      const q = query(collection(FB.db, lbPath()), orderBy('points','desc'), limit(10));
      onSnapshot(q, (snap)=>{
        const rows=[];
        snap.forEach(docSnap=>{
          const d=docSnap.data();
          rows.push(`<li><span>${d.name}</span><span>${d.points} pt</span></li>`);
        });
        ul.innerHTML = rows.length ? rows.join('') : `<li><span>Aucun point</span><span>—</span></li>`;
      });
    }

    // Identity
    let currentUserName = localStorage.getItem('currentUserName') || '';
    function setUserName(name){
      currentUserName=(name||'').trim();
      if(currentUserName) localStorage.setItem('currentUserName', currentUserName);
    }
    // Leaderboard controls
    const lbNameInput=document.getElementById('lbName');
    const lbSaveBtn=document.getElementById('lbSave');
    if(lbNameInput){ lbNameInput.value=currentUserName; }
    if(lbSaveBtn){
      lbSaveBtn.onclick=async ()=>{
        setUserName(lbNameInput.value);
        await ensureNameRegistered(currentUserName);
        renderLeaderboard();
        showScorePopup(`Nom enregistré: ${currentUserName}`);
      };
    }
    renderLeaderboard();

    // ============ Design Studio (canvas + Galerie publique Firebase) ============
    let canvas, ctx, isDrawing=false, currentColor='#ff6b9d', brushSize=5;
    function initCanvas(){
      canvas=document.getElementById('drawingCanvas');
      if(!canvas) return;
      ctx=canvas.getContext('2d');
      ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=currentColor; ctx.lineWidth=brushSize;

      canvas.addEventListener('mousedown', e=>{ isDrawing=true; const r=canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.clientX-r.left,e.clientY-r.top); });
      canvas.addEventListener('mousemove', e=>{ if(!isDrawing) return; const r=canvas.getBoundingClientRect(); ctx.lineTo(e.clientX-r.left, e.clientY-r.top); ctx.stroke(); });
      canvas.addEventListener('mouseup', ()=>{ if(isDrawing){ isDrawing=false; ctx.beginPath(); } });
      canvas.addEventListener('mouseout', ()=>{ if(isDrawing){ isDrawing=false; ctx.beginPath(); } });

      canvas.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.touches[0]; const r=canvas.getBoundingClientRect(); isDrawing=true; ctx.beginPath(); ctx.moveTo(t.clientX-r.left,t.clientY-r.top); }, {passive:false});
      canvas.addEventListener('touchmove', e=>{ if(!isDrawing) return; e.preventDefault(); const t=e.touches[0]; const r=canvas.getBoundingClientRect(); ctx.lineTo(t.clientX-r.left, t.clientY-r.top); ctx.stroke(); }, {passive:false});
      canvas.addEventListener('touchend', ()=>{ if(isDrawing){ isDrawing=false; ctx.beginPath(); } });
    }
    function changeColor(color){ currentColor=color; if(ctx) ctx.strokeStyle=color; }
    function changeBrushSize(size){ brushSize=size; if(ctx) ctx.lineWidth=size; const el=document.getElementById('brushSizeValue'); if(el) el.textContent=size+'px'; }
    function clearCanvas(){ if(ctx&&canvas) ctx.clearRect(0,0,canvas.width,canvas.height); }

    // Galerie publique: Storage + Firestore
    function saveDrawingToGallery(){
      const nameInput=document.getElementById('artistName');
      const userName = (nameInput?.value || currentUserName || '').trim();
      if(!userName){ alert("Entre ton prénom avant de sauvegarder 💅"); return; }
      setUserName(userName); if(lbNameInput) lbNameInput.value=currentUserName;
      if(!window.FB){ alert('Firebase non initialisé'); return; }

      canvas.toBlob(async (blob)=>{
        if(!blob){ alert('Aucun dessin à sauvegarder'); return; }
        const weekId = getWeekId();
        const filePath = `drawings/${weekId}/${userName}/${Date.now()}.png`;
        const { ref, uploadBytes, getDownloadURL, addDoc, collection, serverTimestamp } = FB.fns;
        const fileRef = ref(FB.storage, filePath);
        await uploadBytes(fileRef, blob);
        const url = await getDownloadURL(fileRef);
        await addDoc(collection(FB.db, 'drawings'), { author:userName, url, weekId, createdAt: serverTimestamp() });
        showScorePopup(`Dessin sauvegardé par ${userName} 🎨`);
      }, 'image/png');
    }
    function loadDrawingsGallery(){
      if(!window.FB) return;
      const gal=document.getElementById('drawingsGallery'); if(!gal) return;
      const { collection, query, where, orderBy, onSnapshot } = FB.fns;
      const q = query(collection(FB.db,'drawings'), where('weekId','==', getWeekId()), orderBy('createdAt','desc'));
      onSnapshot(q,(snap)=>{
        const rows=[];
        snap.forEach(docSnap=>{
          const d=docSnap.data();
          rows.push(`
            <div class="drawing-item">
              <img src="${d.url}" alt="Dessin de ${d.author}"/>
              <div class="drawing-author">✨ ${d.author}</div>
            </div>
          `);
        });
        gal.innerHTML = rows.length ? rows.join('') : '<p style="text-align:center;color:#ccc;padding:20px;">Aucun dessin encore... ✨</p>';
      });
    }

    // ============ Morpion (tic-tac-toe) ============
    let tictactoeBoard=['','','','','','','','',''];
    let currentPlayer='X';
    let gameMode='solo';
    let gameActive=true;
    let tictactoeScore={ X:0, O:0, draws:0 };
    const winPatterns=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

    function initTicTacToe(){ tictactoeBoard=['','','','','','','','','']; currentPlayer='X'; gameActive=true; }
    function changeGameMode(mode){
      gameMode=mode; resetTicTacToe();
      const s=document.getElementById('soloBtn'), d=document.getElementById('duoBtn');
      if(s&&d){ s.classList.remove('active'); d.classList.remove('active'); (mode==='solo'?s:d).classList.add('active'); }
      updateInfo();
    }
    function updateInfo(){
      const info=document.getElementById('tictactoeInfo');
      const modeText= (gameMode==='solo')?'Solo (vs IA)':'2 Joueurs';
      if(gameActive && info){ info.textContent = `Mode: ${modeText} | Tour de ${currentPlayer}`; }
    }
    function makeMove(index){
      if(!gameActive || tictactoeBoard[index] !== '') return;
      tictactoeBoard[index]=currentPlayer;
      const cells=document.querySelectorAll('.tictactoe-cell');
      if(cells[index]){
        cells[index].textContent=currentPlayer;
        cells[index].classList.add(currentPlayer.toLowerCase());
        cells[index].disabled=true;
      }
      if(checkWinner()){
        endGame(`${currentPlayer} a gagné ! 🎉`);
        tictactoeScore[currentPlayer]++; updateScore();
        if(currentUserName) addWinPoint(currentUserName);
        return;
      }
      if(tictactoeBoard.every(c=>c!=='')){
        endGame('Égalité ! 🤝'); tictactoeScore.draws++; updateScore(); return;
      }
      currentPlayer=(currentPlayer==='X')?'O':'X'; updateInfo();
      if(gameMode==='solo' && currentPlayer==='O' && gameActive){ setTimeout(aiMove, 500); }
    }
    function checkWinner(){
      return winPatterns.some(p=>{
        const [a,b,c]=p; return tictactoeBoard[a]!=='' && tictactoeBoard[a]===tictactoeBoard[b] && tictactoeBoard[a]===tictactoeBoard[c];
      });
    }
    function endGame(msg){
      gameActive=false;
      const info=document.getElementById('tictactoeInfo'); if(info) info.textContent=msg;
      document.querySelectorAll('.tictactoe-cell').forEach(c=> c.disabled=true);
    }
    function aiMove(){
      if(!gameActive) return;
      let move=findBestMove('O'); if(move===-1) move=findBestMove('X'); if(move===-1) move=getRandomMove();
      if(move!==-1) makeMove(move);
    }
    function findBestMove(player){
      for(const [a,b,c] of winPatterns){
        const cells=[tictactoeBoard[a],tictactoeBoard[b],tictactoeBoard[c]];
        if(cells.filter(v=>v===player).length===2 && cells.includes('')){
          if(tictactoeBoard[a]==='') return a;
          if(tictactoeBoard[b]==='') return b;
          if(tictactoeBoard[c]==='') return c;
        }
      }
      return -1;
    }
    function getRandomMove(){
      const empty=tictactoeBoard.map((v,i)=> v===''?i:null).filter(i=>i!==null);
      return empty.length? empty[Math.floor(Math.random()*empty.length)] : -1;
    }
    function resetTicTacToe(){
      initTicTacToe();
      document.querySelectorAll('.tictactoe-cell').forEach(cell=>{
        cell.textContent=''; cell.disabled=false; cell.classList.remove('x','o');
      });
      updateInfo();
    }
    function updateScore(){
      const sx=document.getElementById('scoreX'), so=document.getElementById('scoreO'), sd=document.getElementById('scoreDraws');
      if(sx) sx.textContent=tictactoeScore.X;
      if(so) so.textContent=tictactoeScore.O;
      if(sd) sd.textContent=tictactoeScore.draws;
    }

    // ============ Mini-jeux: Tetris / Wordle / Memory / Connect4 ============
    window.addWinPoint = window.addWinPoint || function(){};
    window.currentUserName = window.currentUserName || currentUserName;

    // --- Mini Tetris (score + lignes) ---
    let tCanvas, tCtx, tGrid, tPiece, tTimer, tCleared, tScore=0, tLines=0;
    const T_W=10, T_H=20, T_S=24;
    const TETROS={ I:[[1,1,1,1]], O:[[1,1],[1,1]], T:[[0,1,0],[1,1,1]], L:[[1,0],[1,0],[1,1]], J:[[0,1],[0,1],[1,1]], S:[[0,1,1],[1,1,0]], Z:[[1,1,0],[0,1,1]] };
    const COLORS={1:'#ff6b9d'};
    function tNewGrid(){ return Array.from({length:T_H},()=>Array(T_W).fill(0)); }
    function tRandomPiece(){ const ks=Object.keys(TETROS); const k=ks[Math.floor(Math.random()*ks.length)]; return {m:TETROS[k].map(r=>r.slice()), x:3, y:-2}; }
    function tRotate(m){ return m[0].map((_,i)=>m.map(row=>row[i]).reverse()); }
    function tCollide(m,ox,oy){
      for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){
        if(!m[y][x]) continue; const nx=ox+x, ny=oy+y;
        if(nx<0||nx>=T_W||ny>=T_H) return true;
        if(ny>=0 && tGrid[ny][nx]) return true;
      } return false;
    }
    function tMerge(){
      const m=tPiece.m;
      for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){
        if(!m[y][x]) continue; const nx=tPiece.x+x, ny=tPiece.y+y;
        if(ny>=0) tGrid[ny][nx]=1;
      }
    }
    function tClearLines(){
      let cleared=0;
      for(let y=T_H-1;y>=0;y--){
        if(tGrid[y].every(v=>v)){
          tGrid.splice(y,1); tGrid.unshift(Array(T_W).fill(0)); cleared++; y++;
        }
      }
      tCleared+=cleared;
      if(cleared>0){
        // barème simple
        const add = cleared===1?100 : cleared===2?300 : cleared===3?500 : 800;
        tScore += add; tLines += cleared;
        const s=document.getElementById('tScore'), l=document.getElementById('tLines');
        if(s) s.textContent=String(tScore);
        if(l) l.textContent=String(tLines);
        if(currentUserName) addWinPoint(currentUserName);
      }
    }
    function tDraw(){
      tCtx.clearRect(0,0,tCanvas.width,tCanvas.height);
      for(let y=0;y<T_H;y++)for(let x=0;x<T_W;x++){ if(tGrid[y][x]){ tCtx.fillStyle=COLORS[1]; tCtx.fillRect(x*T_S,y*T_S,T_S-1,T_S-1); } }
      const m=tPiece.m; tCtx.fillStyle=COLORS[1];
      for(let y=0;y<m.length;y++)for(let x=0;x<m[0].length;x++){
        if(!m[y][x]) continue; const nx=tPiece.x+x, ny=tPiece.y+y; if(ny>=0) tCtx.fillRect(nx*T_S,ny*T_S,T_S-1,T_S-1);
      }
    }
    function tStep(){
      const ny=tPiece.y+1;
      if(!tCollide(tPiece.m,tPiece.x,ny)) tPiece.y=ny;
      else{
        tMerge(); tClearLines(); tPiece=tRandomPiece();
        if(tCollide(tPiece.m,tPiece.x,tPiece.y)){ clearInterval(tTimer); }
      }
      tDraw();
    }
    function initTetris(container){
      container.innerHTML = `
        <p>Aligne des lignes (⬅️➡️⬇️, R pour pivoter). Efface ≥1 ligne pour +1 point.</p>
        <div style="margin:8px 0; color:#A48D6F;">Score: <span id="tScore">0</span> • Lignes: <span id="tLines">0</span></div>
        <canvas id="tetrisCanvas" width="${T_W*T_S}" height="${T_H*T_S}" style="background:#111;border:2px solid #A48D6F;border-radius:10px;"></canvas>
      `;
      tCanvas=document.getElementById('tetrisCanvas'); tCtx=tCanvas.getContext('2d');
      tGrid=tNewGrid(); tPiece=tRandomPiece(); tCleared=0; tScore=0; tLines=0; tDraw();
      document.onkeydown=(e)=>{
        if(!tPiece) return;
        if(e.key==='ArrowLeft' && !tCollide(tPiece.m,tPiece.x-1,tPiece.y)) tPiece.x--;
        if(e.key==='ArrowRight'&& !tCollide(tPiece.m,tPiece.x+1,tPiece.y)) tPiece.x++;
        if(e.key==='ArrowDown' && !tCollide(tPiece.m,tPiece.x,tPiece.y+1)) tPiece.y++;
        if(e.key==='r'||e.key==='
