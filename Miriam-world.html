<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Miriam's Urban World</title>
  <style>
    /* ... (toute ta partie CSS actuelle ici SANS CHANGEMENT) ... */
  </style>
  <!-- 1. Firebase CDN (Ã  garder AVANT ton script principal) -->
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js"></script>
  <!-- 2. Config et initialisation Firebase PUBLIC -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD2NaFrHU1L-371vMXUuyxr9fHZYz3ePj8",
      authDomain: "lesfeygame.firebaseapp.com",
      projectId: "lesfeygame",
      storageBucket: "lesfeygame.appspot.com",
      messagingSenderId: "799524380159",
      appId: "1:799524380159:web:83b43bdbdd37534dff1bca",
      measurementId: "G-2XTS86C96K"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth();
    auth.signInAnonymously();
    window.FB = { db, storage, auth };
  </script>
</head>
<body>
  <div class="content">
    <!-- TON HEADER, GAME WORLD, ETC. NE CHANGE PAS ICI -->
    <!-- ... (identique Ã  ce que tu avais, sauf JS adaptÃ© ci-dessous) ... -->
    <!-- LEADERBOARD ET MODAL INCHANGE -->
  </div>
  <script>
    // ==== Semaine ISO ====
    function getWeekId(d=new Date()){
      const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      date.setUTCDate(date.getUTCDate()+4-(date.getUTCDay()||7));
      const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));
      const weekNo=Math.ceil((((date - yearStart)/86400000)+1)/7);
      return `${date.getUTCFullYear()}-${String(weekNo).padStart(2,'0')}`;
    }
    // ==== Classement Firestore ====
    function lbPath(){ return `leaderboards/${getWeekId()}/scores`; }
    async function addWinPoint(name){
      if(!name || !window.FB) return;
      const ref = FB.db.collection(lbPath()).doc(name.trim().toLowerCase());
      const snap = await ref.get();
      if(!snap.exists){ await ref.set({ name, points:1 }); }
      else{ await ref.update({ points: firebase.firestore.FieldValue.increment(1) }); }
    }
    function renderLeaderboard(){
      if(!window.FB) return;
      const ul=document.getElementById('leaderboardList'), w=document.getElementById('lbWeek');
      if(!ul||!w) return;
      w.textContent=getWeekId();
      FB.db.collection(lbPath()).orderBy("points","desc").limit(10).onSnapshot(snap => {
        ul.innerHTML = snap.size 
          ? Array.from(snap.docs).map(d=>`<li><span>${d.data().name}</span><span>${d.data().points} pt</span></li>`).join('')
          : `<li><span>Aucun point</span><span>â€”</span></li>`;
      });
    }
    // ==== Galerie Firestore+Storage public ====
    function saveDrawingToGallery(){
      const nameInput=document.getElementById('artistName');
      const userName=(nameInput?.value||window.currentUserName||'').trim();
      if(!userName){ alert('Entre ton prÃ©nom ðŸ’…'); return; }
      setUserName(userName);
      if(!window.canvas){ alert('Aucune dessin Ã  sauvegarder'); return; }
      canvas.toBlob(async blob=>{
        if(!blob){ alert('Erreur dessin'); return; }
        const weekId = getWeekId();
        const filePath = `drawings/${weekId}/${userName}/${Date.now()}.png`;
        const fileRef = FB.storage.ref(filePath);
        await fileRef.put(blob);
        const url = await fileRef.getDownloadURL();
        await FB.db.collection('drawings').add({ author:userName, url, weekId, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
        showScorePopup(`Dessin sauvegardÃ© !`);
      },'image/png');
    }
    function loadDrawingsGallery(){
      if(!window.FB) return;
      const gal=document.getElementById('drawingsGallery'); if(!gal) return;
      FB.db.collection('drawings').where('weekId','==',getWeekId()).orderBy('createdAt','desc').onSnapshot(snap=>{
        gal.innerHTML = snap.size 
          ? Array.from(snap.docs).map(d=>
            `<div class="drawing-item">
              <img src="${d.data().url}" alt="Dessin de ${d.data().author}"/>
              <div class="drawing-author">âœ¨ ${d.data().author}</div>
            </div>`).join('')
          : '<p style="text-align:center;color:#ccc;padding:20px;">Aucun dessin encore... âœ¨</p>';
      });
    }
    // ==== Games, Tetris, init, autres mini-jeux: rien Ã  modifier si tu utilises FB.db et FB.storage ====
    /* ... (reste de ton JS inchangÃ©, jeux, modals, etc. ...) ... */
  </script>
</body>
</html>
